# mip-docker-swarm
MIPテストネットへの対応として、チェーンごとの別サーバー化が必要なので、全ノードをうまーく統合管理できるよう、docker swarmを活用することにしました
(最初はkubernetesでやろうとしたけどまだ慣れているこっちから作ることにしました）。

構造は画像のとおり。
![thegraph-mip-pic01](https://user-images.githubusercontent.com/15893314/193045327-07b08c45-a31e-4640-a26a-a95fe28f9a4c.png)

今回の構成では、Contabo Cloud VPS XLをチェーン数分＋マネージャーノード1台を借りて構成を作ることにしました（私は、ということなので皆さんはnotionから見て大丈夫な性能で十分です）。
最初のブランチphase0では、必要となるインデックスノード、クエリノードのみをホストします。
また、ネットワーク処理としてtraefikを、docker swarmのWebUIとしてswarmpitをインストールしています。

手続きは、以下のとおりです。
1. VPSを契約する（最低2台）
1. ENS(goerli), ドメインを取得する
1. VPSの初期設定をする（https://ayame.space/2021/03/ubuntu-20-04-initialize/ のDocker環境の構築直前までぐらいやれば十分）
1. dockerをインストールする
1. githubレポをクローンする
1. スクリプトをいくらか動かして設定をする
1. 動くか確認する

ここでは、最初の1~3を省略し、4からやっていきます。

## 4. dockerをインストールする
dockerは、次の手続きでインストールしましょう。ここから、サーバーごとに実施することを明記したコマンドを除き、使用するサーバー全てで同じことを行ってください。
```
curl -fsSL https://get.docker.com/ | sh
```
この後、
```
sudo usermod -aG docker [ユーザー名]
sudo service docker restart
```
を実施し、ターミナルを開きなおしましょう。
これにより、非rootユーザーでもdockerを使用できます。

## 5. githubレポをクローンする
このレポのスクリプトでほぼインストールは完了するので、次の順番でコードを入れていきましょう。
``` 
sudo apt-get install -y git
git clone https://github.com/liray-unendlich/mip-docker-swarm.git
cd mip-docker-swarm
```
ここまでで、コードのダウンロードが完了しました。中には、example.envが入っているので、自分用に修正して使いましょう。
修正が完了したら、.envとして保存してください。
最下部に、envがそれぞれどのような意味か記載していますので、見ながら入力ください。

## 6. スクリプトを動かして設定する
それでは、スクリプトを使って、サーバーごとの初期設定（docker swarmの設定用）を行いましょう。
まず、次のコマンドを、マネージャーサーバーに対して実施します。
```
chmod +x init-phase0-manager.sh
bash init-phase0-manager.sh
```
スクリプト実行時、管理者パスワードの入力が必要となります。また、最後には他サーバーが同じクラスターに入るためのトークンが出力されるので、メモしましょう。

このスクリプトによって、docker swarmのクラスターが生成され、必要なUI機能をインストールしました。
次に、各チェーン用サーバーの初期設定を実施しましょう。※各チェーンサーバーで、3~5を実施した後に実施してください
```
chmod +x init-phase0-worker.sh
bash init-phase0-worker.sh
```
このスクリプトでは、どのチェーンを同期するのか及びクラスター追加トークン（上のマネージャーサーバースクリプトの終了時に表示されたトークン）を入力します。

ここまでで、最低二つのサーバーが同じクラスター上に統合されました。実際に、統合されていることを確認するため、Web UIを確認しましょう。
envで設定した"swarmpit.sld.tld"に接続してみましょう。すると、最初にアカウント設定を要求された後、ログインできるようになるはずです。
ここでは、複数のサーバーにまたがって同じクラスターのサーバーの処理状況やプロセス状況を確認することが出来ます。
後で初期設定をする、インデックスサーバーの設定のログや、様々な設定をWebUIから変更できます。
次に、実際にphase0を完了するために設定を続けましょう。

## 7. phase0のためのインデックスサーバーを設定する
次のコマンドは、マネージャーサーバー上で実施してください。
```
chmod +x add-phase0-worker.sh
bash init-phase0-worker.sh
```
このスクリプトでは、どのチェーンをインデックスするのか（6で設定したサーバーと同じが好ましいです）を入力し、チェーンのRPC（アーカイブノードが必要）のURLを入力する必要があります。

このスクリプトが完了すると、6で確認したswarmpitで、インデックスサービスの状態を見ることが出来るはずです。

ロガーとかそういうのはまた今度やります・・・・（9/29）
